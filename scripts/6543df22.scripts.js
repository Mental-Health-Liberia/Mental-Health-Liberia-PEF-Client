"use strict";angular.module("pefApp",["ui.bootstrap","ui.router","ngSanitize"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/"),a.state("main",{url:"/",templateUrl:"views/page.html",controller:"PageCtrl"})}]),angular.module("pefApp").service("$config",["$http","$rootScope","$form",function(a,b,c){function d(){a.get("configuration.json").success(function(a){e=a,f=e.tabs,f.push({title:"Confirm",name:"confirm",alert:"Carefully review the information and scroll down to the bottom of the page to save.",templateUrl:"confirm"}),b.$broadcast("tabsReady")})}var e=null,f=null,g=0;b.$on("reset",function(){d()}),d();var h=function(a){return null!==e?a(e):void 0},i=function(a){return null!==f?a(f):void 0},j=function(a){i(function(c){g=a,b.$broadcast("selectedTabChanged",c[g])})},k=function(){g=-1,b.$broadcast("selectedTabChanged",null)},l=function(){j(g+1)},m=function(){j(g-1)},n=function(a){i(function(b){return a(b[g])})},o=function(){return g},p=function(a){var b={};i(function(c){for(var d in c){var e=c[d];for(var f in e.fieldsets){var g=e.fieldsets[f];for(var h in g.elements){var i=g.elements[h];b[i.name]=i.value}}}a(b)})},q=function(a){p(function(a){c.add(a)}),a()};return{get:h,tabs:i,selectTab:j,deselectTab:k,nextTab:l,lastTab:m,selectedTab:n,selectedTabIndex:o,submit:q}}]),angular.module("pefApp").directive("pefElement",["$compile",function(a){var b={select:{init:function(a){a.options&&(a.value=a.options[0])},template:'<select ng-model="value" id="{{name}}" name="{{name}}" ng-options="option for option in options"></select>'},text:{template:'<input type="text" ng-model="value" id="{{name}}" name="{{name}}" placeholder="{{placeholder}}">'},patient_id:{template:'<div class="input-append"><input type="text" ng-model="value" id="{{name}}" name="{{name}}" placeholder="{{placeholder}}"><button class="btn">Generate</button></div>'},radio:{init:function(a){a.options&&(a.value=a.options[0])},template:'<label class="radio" ng-repeat="option in options"><input type="radio" ng-model="$parent.value" value="{{option}}"> {{option}} </label>'},checkbox:{init:function(a){a.value=a.value||[],a.isChecked=function(b){return-1!==_.indexOf(a.value,b)},a.check=function(b){a.isChecked(b)?_.pull(a.value,b):a.value.push(b)}},template:'<label class="checkbox" ng-repeat="option in options"><input type="checkbox" name="{{name}}[]" ng-checked="isChecked(option)" ng-click="check(option)"> {{option}} </label>'},datepicker:{init:function(a){a.maxDate=Date.now(),a.value=Date.now()},template:'<div class="well well-small pull-left"><datepicker class="datepicker" ng-model="value" max="maxDate" show-weeks="showWeeks" day-format="\'d\'"></timepicker></div>'},timepicker:{init:function(a){a.value=Date.now()},template:'<div class="well well-small pull-left" ng-model="value"><timepicker class="timepicker" show-meridian="true"></timepicker></div>'}};return{restrict:"E",scope:{name:"=name",type:"=type",options:"=options",value:"=value",placeholder:"=placeholder",help:"=help",rules:"=rules",valid:"=valid",validate:"=validate",invalidMessage:"=invalidMessage"},link:function(c,d){c.valid=!0,c.$watch("value",function(){c.validate(c)}),_.has(b,c.type)&&(void 0!==b[c.type].init&&b[c.type].init(c),d.prepend(b[c.type].template),d.append('<span class="help-inline" ng-show="help && valid"><span class="text-warning">{{help}}</span></span>'),d.append('<span class="help-inline" ng-show="!valid">This field {{invalidMessage}}.</span>')),a(d.contents())(c)}}}]),angular.module("pefApp").service("$form",["$http","$rootScope",function(a,b){var c=function(){var a=parseInt(window.localStorage.formCount,10);return a||(window.localStorage.formCount=0,a=0),a},d=function(){var a=c();window.localStorage.formCount=a+1},e=function(){var a=c();window.localStorage.formCount=a-1},f=function(){for(var a=c(),b=[],d=0;a>d;d++)b.push(JSON.parse(window.localStorage["form-"+d]));return b},g=function(a){var e=c();window.localStorage["form-"+e]=JSON.stringify(a),d(),b.$broadcast("formsUpdated")},h=function(a){var d=c();if(!(a>=d||0>a)){for(var f=a;d-2>=f;f++)window.localStorage["form-"+f]=window.localStorage["form-"+(f+1)];e(),b.$broadcast("formsUpdated")}},i=function(b){a({method:"GET",url:"/"}).success(function(){b(!0)}).error(function(){b(!1)})},j=function(b,c){a({method:"POST",url:"/forms.json",data:b.form}).success(function(){h(b.index),c()}).error(function(a){c(a)})},k=function(a){for(var b=f(),c=0;c<b.length;c++)b[c]={index:c,form:b[c]};b.reverse(),async.eachSeries(b,j,function(b){b?(console.error(b),a(!1)):a(!0)})};return{get:f,add:g,serverAvailable:i,uploadAllForms:k}}]),angular.module("pefApp").controller("NavbarCtrl",["$scope","$rootScope","$config","$form","$modal",function(a,b,c,d,e){a.maxValidTabIndex=0,a.documents=d.get(),b.$on("tabsReady",function(){c.tabs(function(b){a.tabs=b.map(function(d){return{title:d.title,slug:d.name,selected:_.indexOf(b,d)===c.selectedTabIndex(),disabled:_.indexOf(b,d)>a.maxValidTabIndex}})})}),a.$on("formsUpdated",function(){a.documents=d.get()}),a.$on("selectedTabChanged",function(){a.maxValidTabIndex=Math.max(a.maxValidTabIndex,c.selectedTabIndex()),_.forEach(a.tabs,function(b){b.selected=_.indexOf(a.tabs,b)===c.selectedTabIndex(),b.disabled=_.indexOf(a.tabs,b)>a.maxValidTabIndex})}),b.$on("reset",function(){a.maxValidTabIndex=0}),a.tabSelected=function(a){c.selectTab(a)},a.uploadForms=function(){d.serverAvailable(function(b){var c;c=b?e.open({templateUrl:"views/login_modal.html",controller:"LoginModalCtrl",resolve:{header:function(){return"Log In to Upload Forms"},content:function(){return""},formsToUpload:function(){return a.documents.length}}}):e.open({templateUrl:"views/modal.html",controller:"ModalCtrl",resolve:{header:function(){return"Upload Forms"},content:function(){return"Please connect to the internet to upload the forms."}}})})},c.selectTab(0)}]),angular.module("pefApp").controller("PageCtrl",["$scope","$rootScope","$config","$modal",function(a,b,c,d){var e={one_required:{test:function(a){return a.some(function(a){return void 0!==a&&null!==a&&a.length>0})},message:"must have at least one completed field"}},f={number:{test:function(a){return void 0===a||/^[0-9]*$/.test(a)},message:"should be a number"},required:{test:function(a){return void 0!==a&&null!==a&&0!==a.trim().length},message:"is required"}};b.$on("tabsReady",function(){c.selectTab(0)}),a.$on("selectedTabChanged",function(b,d){c.tabs(function(b){a.tabs=b}),a.selectedTab=d,$("html, body").animate({scrollTop:0},200)}),a.continueButtonClicked=function(){var b=[];for(var e in a.selectedTab.fieldsets){var f=a.selectedTab.fieldsets[e],g=a.validateFieldset(f,!0);b=b.concat(g)}document.getElementById("continueButton").blur(),document.getElementById("backButton").blur(),0===b.length?c.nextTab():d.open({templateUrl:"views/modal.html",controller:"ModalCtrl",resolve:{header:function(){return null},content:function(){return["<p><strong>Please fix the following errors before continuing:</strong></p>","<ul>","<li>",b.join("</li><li>"),"</li>","</ul>"].join("")},buttons:function(){return["OK"]}}})},a.backButtonClicked=function(){c.lastTab()},a.backButtonDisabled=function(){return 0===c.selectedTabIndex()},a.saveButtonClicked=function(){var a=d.open({templateUrl:"views/modal.html",controller:"ModalCtrl",resolve:{header:function(){return"Save Form"},content:function(){return"Once the form has been saved, it can no longer be edited. Are you sure you want to save the form?"},buttons:function(){return["Save","Don't Save"]}}});a.result.then(function(a){"Save"===a&&c.submit(function(){b.$broadcast("reset"),c.selectTab(0)})})},a.validateFieldset=function(b,c){function d(a){return a.value}var f=[];for(var g in b.elements){var h=b.elements[g];a.validate(h,!0)||f.push(h.title+" "+h.invalidMessage+".")}if(c&&b.rules)for(var i in b.rules){var j=e[i];if(j){var k=b.elements.map(d),l=j.test(k);l||f.push(b.title+" "+j.message+".")}}return f},a.validate=function(a,b){var c=a.value;if((b||void 0!==c)&&a.rules)for(var d in a.rules){var e=f[d];if(e){var g=e.test(c);if(!g)return a.valid=!1,a.invalidMessage=e.message,!1}}return a.valid=!0,a.invalidMessage=null,!0},a.formatDate=function(a){return moment(a).format("MMMM Do YYYY")}}]),angular.module("pefApp").controller("ModalCtrl",["$scope","$modalInstance","$sce","header","content","buttons",function(a,b,c,d,e,f){a.header=d,a.content=c.trustAsHtml(e),a.buttons=f,a.buttonClicked=function(a){b.close(a)}}]),angular.module("pefApp").controller("LoginModalCtrl",["$scope","$http","$modalInstance","$form","header","formsToUpload",function(a,b,c,d,e,f){a.header=e,a.formsToUpload=f,a.$watch("username",function(){a.failureMessage=null}),a.$watch("password",function(){a.failureMessage=null}),a.ok=function(){a.username&&a.password&&b({method:"POST",url:"/users/sign_in.json",data:{user:{username:a.username,password:a.password}}}).success(function(b){b.success?d.uploadAllForms(function(){c.close()}):a.failureMessage=b.errors&&b.errors.length>0?b.errors.join(" "):"Something went wrong. Please try again later."}).error(function(b){a.failureMessage=b})},a.cancel=function(){c.dismiss("cancel")}}]);