"use strict";angular.module("pefApp",["ui.bootstrap","ui.router","ngSanitize"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/"),a.state("main",{url:"/",templateUrl:"views/page.html",controller:"PageCtrl"})}]),angular.module("pefApp").service("$config",["$http","$rootScope","$form","$modal",function(a,b,c,d){function e(){a.get("/configuration.json").success(function(a){h=a,i=h.tabs,i.push({title:"Confirm",name:"confirm",alert:"Carefully review the information and scroll down to the bottom of the page to save.",templateUrl:"confirm"}),b.$broadcast("tabsReady")})}var f={one_required:{test:function(a){return a.some(function(a){return void 0!==a&&null!==a&&a.length>0})},message:"must have at least one completed field"}},g={number:{test:function(a){return void 0===a||/^[0-9]*$/.test(a)},message:"should be a number"},required:{test:function(a){return void 0!==a&&null!==a&&0!==a.trim().length},message:"is required"}},h=null,i=null,j=0;b.$on("reset",function(){e()}),e();var k=function(a){return null!==h?a(h):void 0},l=function(a){return null!==i?a(i):void 0},m=function(a){l(function(c){j=a,b.$broadcast("selectedTabChanged",c[j])})},n=function(){j=-1,b.$broadcast("selectedTabChanged",null)},o=function(){m(j+1)},p=function(){m(j-1)},q=function(){return i[j]},r=function(){return j},s=function(a){var b={};l(function(c){for(var d in c){var e=c[d];for(var f in e.fieldsets){var g=e.fieldsets[f];for(var h in g.elements){var i=g.elements[h];b[i.name]=i.value}}}a(b)})},t=function(a){s(function(a){c.add(a)}),a()},u=function(a){var b=[];for(var c in a.fieldsets){var d=a.fieldsets[c],e=w(d,!0);b=b.concat(e)}return document.getElementById("continueButton").blur(),document.getElementById("backButton").blur(),b},v=function(a){d.open({templateUrl:"views/modal.html",controller:"ModalCtrl",resolve:{header:function(){return null},content:function(){return["<p><strong>Please fix the following errors before continuing:</strong></p>","<ul>","<li>",a.join("</li><li>"),"</li>","</ul>"].join("")},buttons:function(){return["OK"]}}})},w=function(a,b){function c(a){return a.value}var d=[];for(var e in a.elements){var g=a.elements[e];x(g,b)||d.push(g.title+" "+g.invalidMessage+".")}if(b&&a.rules)for(var h in a.rules){var i=f[h];if(i){var j=a.elements.map(c),k=i.test(j);k||d.push(a.title+" "+i.message+".")}}return d},x=function(a,b){var c=a.value;if((b||void 0!==c&&null!==c&&c.length>0)&&a.rules)for(var d in a.rules){var e=g[d];if(e){var f=e.test(c);if(!f)return a.valid=!1,a.invalidMessage=e.message,!1}}return a.valid=!0,a.invalidMessage=null,!0};return{get:k,tabs:l,selectTab:m,deselectTab:n,nextTab:o,lastTab:p,selectedTab:q,selectedTabIndex:r,submit:t,tabInvalidMessages:u,showInvalidModal:v,validateFieldset:w,validate:x}}]),angular.module("pefApp").directive("pefElement",["$compile","$modal",function(a,b){var c={select:{init:function(a){a.options&&(a.value=a.value||a.options[0])},template:'<select ng-model="value" id="{{name}}" name="{{name}}" ng-options="option for option in options"></select>'},text:{template:'<input type="text" ng-model="value" id="{{name}}" name="{{name}}" placeholder="{{placeholder}}">'},patient_id:{init:function(a){a.generateButtonClicked=function(){var c=b.open({templateUrl:"views/generate_modal.html",controller:"GenerateModalCtrl",resolve:{header:function(){return"Generate Patient ID"},content:function(){return""}}});c.result.then(function(b){"Cancel"!==b&&(a.value=b.toString())})},a.resetButtonClicked=function(){this.value=null}},template:'<button class="btn" ng-click="generateButtonClicked()" ng-bind="value ? \'Generated\' : \'Generate\'" ng-disabled="value" ng-class="{\'btn-success\': value}"></button> <button class="btn" ng-click="resetButtonClicked()" ng-show="value">Reset</button>'},radio:{init:function(a){a.options&&(a.value=a.value||a.options[0])},template:'<label class="radio" ng-repeat="option in options"><input type="radio" ng-model="$parent.value" value="{{option}}"> {{option}} </label>'},checkbox:{init:function(a){a.value=a.value||[],a.isChecked=function(b){return-1!==_.indexOf(a.value,b)},a.check=function(b){a.isChecked(b)?_.pull(a.value,b):a.value.push(b)}},template:'<label class="checkbox" ng-repeat="option in options"><input type="checkbox" name="{{name}}[]" ng-checked="isChecked(option)" ng-click="check(option)"> {{option}} </label>'},datepicker:{init:function(a){a.maxDate=Date.now(),a.value=a.value||Date.now()},template:'<div class="well well-small pull-left"><datepicker class="datepicker" ng-model="value" max="maxDate" show-weeks="showWeeks" day-format="\'d\'"></timepicker></div>'},timepicker:{init:function(a){a.value=a.value||Date.now()},template:'<div class="well well-small pull-left" ng-model="value"><timepicker class="timepicker" show-meridian="true"></timepicker></div>'}};return{restrict:"E",scope:{name:"=name",type:"=type",options:"=options",value:"=value",placeholder:"=placeholder",help:"=help",rules:"=rules",valid:"=valid",validate:"=validate",invalidMessage:"=invalidMessage"},link:function(b,d){b.valid=!0,b.$watch("value",function(){b.validate(b)}),_.has(c,b.type)&&(void 0!==c[b.type].init&&c[b.type].init(b),d.prepend(c[b.type].template),d.append('<span class="help-inline" ng-show="help && valid"><span class="text-warning">{{help}}</span></span>'),d.append('<span class="help-inline" ng-show="!valid">This field {{invalidMessage}}.</span>')),a(d.contents())(b)}}}]),angular.module("pefApp").service("$form",["$http","$rootScope",function(a,b){var c=function(){var a=parseInt(window.localStorage.formCount,10);return a||(window.localStorage.formCount=0,a=0),a},d=function(){var a=c();window.localStorage.formCount=a+1},e=function(){var a=c();window.localStorage.formCount=a-1},f=function(){for(var a=c(),b=[],d=0;a>d;d++)b.push(JSON.parse(window.localStorage["form-"+d]));return b},g=function(a){var e=c();window.localStorage["form-"+e]=JSON.stringify(a),d(),b.$broadcast("formsUpdated")},h=function(a){var d=c();if(!(a>=d||0>a)){for(var f=a;d-2>=f;f++)window.localStorage["form-"+f]=window.localStorage["form-"+(f+1)];e(),b.$broadcast("formsUpdated")}},i=function(b){a({method:"GET",url:"/"}).success(function(){b(!0)}).error(function(){b(!1)})},j=function(b,c){a({method:"POST",url:"/forms.json",data:b.form}).success(function(){h(b.index),c()}).error(function(a){c(a)})},k=function(a){for(var b=f(),c=0;c<b.length;c++)b[c]={index:c,form:b[c]};b.reverse(),async.eachSeries(b,j,function(b){b?(console.error(b),a(!1)):a(!0)})};return{get:f,add:g,serverAvailable:i,uploadAllForms:k}}]),angular.module("pefApp").controller("NavbarCtrl",["$scope","$rootScope","$config","$form","$modal",function(a,b,c,d,e){a.maxValidTabIndex=0,a.documents=d.get(),b.$on("tabsReady",function(){c.tabs(function(b){a.tabs=b.map(function(d){return{title:d.title,slug:d.name,selected:_.indexOf(b,d)===c.selectedTabIndex(),disabled:_.indexOf(b,d)>a.maxValidTabIndex}})})}),a.$on("formsUpdated",function(){a.documents=d.get()}),a.$on("selectedTabChanged",function(){a.maxValidTabIndex=Math.max(a.maxValidTabIndex,c.selectedTabIndex()),_.forEach(a.tabs,function(b){b.selected=_.indexOf(a.tabs,b)===c.selectedTabIndex(),b.disabled=_.indexOf(a.tabs,b)>a.maxValidTabIndex})}),b.$on("reset",function(){a.maxValidTabIndex=0}),a.tabSelected=function(a){if(a>c.selectedTabIndex()){var b=c.tabInvalidMessages(c.selectedTab());if(b.length>0)return c.showInvalidModal(b),void 0}c.selectTab(a)},a.uploadForms=function(){d.serverAvailable(function(b){var c;c=b?e.open({templateUrl:"views/login_modal.html",controller:"LoginModalCtrl",resolve:{header:function(){return"Log In to Upload Forms"},content:function(){return""},formsToUpload:function(){return a.documents.length}}}):e.open({templateUrl:"views/modal.html",controller:"ModalCtrl",resolve:{header:function(){return"Upload Forms"},content:function(){return"Please connect to the internet to upload the forms."},buttons:function(){return["OK"]}}})})},c.selectTab(0)}]),angular.module("pefApp").controller("PageCtrl",["$scope","$rootScope","$config","$modal",function(a,b,c,d){b.$on("tabsReady",function(){c.selectTab(0)}),a.$on("selectedTabChanged",function(b,d){c.tabs(function(b){a.tabs=b}),a.selectedTab=d,$("html, body").animate({scrollTop:0},200)}),a.continueButtonClicked=function(){var a=c.tabInvalidMessages(c.selectedTab());return a.length>0?(c.showInvalidModal(a),void 0):(c.nextTab(),void 0)},a.backButtonClicked=function(){c.lastTab()},a.backButtonDisabled=function(){return 0===c.selectedTabIndex()},a.saveButtonClicked=function(){var a=d.open({templateUrl:"views/modal.html",controller:"ModalCtrl",resolve:{header:function(){return"Save Form"},content:function(){return"Once the form has been saved, it can no longer be edited. Are you sure you want to save the form?"},buttons:function(){return["Save","Don't Save"]}}});a.result.then(function(a){"Save"===a&&c.submit(function(){b.$broadcast("reset"),c.selectTab(0)})})},a.formatDate=function(a){return moment(a).format("MMMM Do YYYY")},a.validate=c.validate}]),angular.module("pefApp").controller("ModalCtrl",["$scope","$modalInstance","$sce","header","content","buttons",function(a,b,c,d,e,f){a.header=d,a.content=c.trustAsHtml(e),a.buttons=f,a.buttonClicked=function(a){b.close(a)}}]),angular.module("pefApp").controller("LoginModalCtrl",["$scope","$http","$modalInstance","$form","header","formsToUpload",function(a,b,c,d,e,f){a.header=e,a.formsToUpload=f,a.$watch("username",function(){a.failureMessage=null}),a.$watch("password",function(){a.failureMessage=null}),a.ok=function(){a.username&&a.password&&b({method:"POST",url:"/users/sign_in.json",data:{user:{username:a.username,password:a.password}}}).success(function(b){b.success?d.uploadAllForms(function(){c.close()}):a.failureMessage=b.errors&&b.errors.length>0?b.errors.join(" "):"Something went wrong. Please try again later."}).error(function(b){a.failureMessage=b})},a.cancel=function(){c.dismiss("Cancel")}}]),angular.module("pefApp").controller("GenerateModalCtrl",["$scope","$modalInstance","header",function(a,b,c){var d="Month",e="Day",f="Year";a.header=c,a.firstName="",a.lastName="",a.month=d,a.day=e,a.year=f,a.hash=function(){var b=[];return b=[],b.push(a.firstName.replace(/[^A-Za-z]/g,"").toUpperCase()),b.push(a.lastName.replace(/[^A-Za-z]/g,"").toUpperCase()),a.unknownBirthdate||b.push(a.month,a.day,a.year),b.join("").split("").reduce(function(a,b){return a=(a<<5)-a+b.charCodeAt(0),a&a},0)},a.generate=function(){a.valid()&&b.close(a.hash())},a.cancel=function(){b.dismiss("Cancel")},a.valid=function(){return a.unknownBirthdate||a.month!==d&&a.day!==e&&a.year!==f?0===a.firstName.replace(/[^A-Za-z]/g,"").length||0===a.lastName.replace(/[^A-Za-z]/g,"").length?!1:!0:!1},a.months=function(){var b=["January","February","March","April","May","June","July","August","September","October","November","December"];return a.month===d&&b.unshift(d),b},a.days=function(){var b,c=[];b="February"===a.month?29:_.contains(["January","March","May","July","August","October","December"],a.month)?31:30;for(var d=1;b>=d;d++)c.push(d);return a.day===e&&c.unshift(e),c},a.years=function(){for(var b=[],c=130,d=moment().year(),e=d;e>=d-c;e--)b.push(e);return a.year===f&&b.unshift(f),b}}]);